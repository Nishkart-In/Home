
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin · Products</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/styles.css">
  <script src="/config.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root { color-scheme: dark; }
    body { max-width: 960px; margin: 2rem auto; padding: 0 12px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    h1,h2,h3 { margin: 0 0 12px; }
    form .row { display:grid; grid-template-columns: 1fr 2fr; gap:10px; align-items:center; margin-bottom:10px; }
    input, textarea, select { padding:.6rem; border-radius:10px; border:1px solid #444; background:#111; color:#fff; width:100%; }
    button { padding:.6rem 1rem; border-radius:10px; border:1px solid #444; background:#222; color:#fff; cursor:pointer; }
    button:hover { background:#2a2a2a; }
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:16px; }
    .card { border:1px solid #333; padding:12px; border-radius:14px; background:#0b0b0b; }
    .hidden { display:none; }
    .muted { color:#aaa; }
  </style>
</head>
<body>
  <h1>Admin Panel</h1>

  <section id="auth">
    <div class="card">
      <h3>Login</h3>
      <div class="row">
        <label>Email</label><input id="email" type="email" required>
      </div>
      <div class="row">
        <label>Password</label><input id="password" type="password" required>
      </div>
      <button id="loginBtn">Login</button>
      <p id="authMsg" class="muted"></p>
      <p class="muted">Tip: Create your user in Supabase → Authentication → Users.</p>
    </div>
  </section>

  <section id="app" class="hidden">
    <div class="card">
      <h3>Add / Update Product</h3>
      <form id="pform">
        <div class="row"><label>Name</label><input id="name" required></div>
        <div class="row"><label>Slug</label><input id="slug" required placeholder="auto from name"></div>
        <div class="row"><label>Price (INR)</label><input id="price" type="number" min="0" required></div>
        <div class="row"><label>Short</label><input id="short"></div>
        <div class="row"><label>Description</label><textarea id="description" rows="4"></textarea></div>
        <div class="row"><label>Tags (comma)</label><input id="tags" placeholder="Kitchen, Storage"></div>
        <div class="row"><label>In Stock?</label>
          <select id="in_stock"><option value="true">Yes</option><option value="false">No</option></select>
        </div>
        <div class="row"><label>Specs (key:value, one per line)</label>
          <textarea id="specs" rows="4" placeholder="Material: Cotton&#10;Size: 30x30cm"></textarea>
        </div>
        <div class="row"><label>Images</label><input id="images" type="file" accept="image/*" multiple></div>
        <button type="submit">Save Product</button>
        <span id="saveMsg" style="margin-left:8px;"></span>
      </form>
    </div>

    <div class="card">
      <h3>Existing Products</h3>
      <div id="list" class="grid"></div>
    </div>
  </section>

  <script>
    const supabase = window.supabase.createClient(NKCFG.SUPABASE_URL, NKCFG.SUPABASE_ANON_KEY);
    const authBox = document.getElementById('auth');
    const appBox = document.getElementById('app');

    // Login
    document.getElementById('loginBtn').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      document.getElementById('authMsg').textContent = error ? error.message : 'Logged in!';
      if (!error) { authBox.classList.add('hidden'); appBox.classList.remove('hidden'); loadList(); }
    };

    // Keep session if already logged in
    supabase.auth.getSession().then(({ data }) => {
      if (data.session) { authBox.classList.add('hidden'); appBox.classList.remove('hidden'); loadList(); }
    });

    // Auto slug
    document.getElementById('name').addEventListener('input', e => {
      const s = e.target.value.toLowerCase().trim()
        .replace(/[^a-z0-9\s-]/g,'')
        .replace(/\s+/g,'-')
        .replace(/-+/g,'-');
      const slugEl = document.getElementById('slug');
      if (!slugEl.value) slugEl.value = s;
    });

    // Save product (create or update by slug)
    document.getElementById('pform').addEventListener('submit', async (e) => {
      e.preventDefault();
      const saveMsg = document.getElementById('saveMsg'); saveMsg.textContent = 'Saving...';

      const name = document.getElementById('name').value.trim();
      const slug = document.getElementById('slug').value.trim();
      const price = parseInt(document.getElementById('price').value,10) || 0;
      const short = document.getElementById('short').value.trim();
      const description = document.getElementById('description').value.trim();
      const tags = document.getElementById('tags').value.split(',').map(s => s.trim()).filter(Boolean);
      const in_stock = document.getElementById('in_stock').value === 'true';
      const specsStr = document.getElementById('specs').value;
      const specs = {};
      specsStr.split('\n').forEach(line => {
        const i = line.indexOf(':');
        if (i>0) specs[line.slice(0,i).trim()] = line.slice(i+1).trim();
      });

      // Upload images if any
      const files = Array.from(document.getElementById('images').files || []);
      const imageUrls = [];
      for (const f of files) {
        const path = `${slug}/${Date.now()}-${f.name.replace(/\s+/g,'-')}`;
        const { error: upErr } = await supabase.storage.from('product-images').upload(path, f, { upsert: true });
        if (upErr) { saveMsg.textContent = 'Upload failed: ' + upErr.message; return; }
        const { data } = supabase.storage.from('product-images').getPublicUrl(path);
        imageUrls.push(data.publicUrl);
      }

      // Merge with existing if updating
      const { data: existing } = await supabase.from('products').select('*').eq('slug', slug).limit(1).maybeSingle();
      const payload = {
        name, slug, price, short, description, tags, in_stock,
        specs,
        images: files.length ? imageUrls : (existing?.images || [])
      };

      let dbErr;
      if (existing) {
        const { error } = await supabase.from('products').update(payload).eq('id', existing.id);
        dbErr = error;
      } else {
        const { error } = await supabase.from('products').insert(payload);
        dbErr = error;
      }

      if (dbErr) { saveMsg.textContent = 'DB error: ' + dbErr.message; return; }
      saveMsg.textContent = 'Saved ✅';
      (document.getElementById('pform')).reset();
      loadList();
    });

    async function loadList() {
      const { data, error } = await supabase.from('products').select('id,slug,name,price,in_stock,images').order('created_at',{ascending:false});
      const list = document.getElementById('list');
      if (error) { list.innerHTML = 'Failed: ' + error.message; return; }
      list.innerHTML = (data||[]).map(p => `
        <div class="card">
          <strong>${p.name}</strong><br>
          ₹${p.price} · ${p.in_stock ? 'In stock' : 'Out of stock'}<br>
          <small class="muted">${p.slug}</small><br>
          ${Array.isArray(p.images) && p.images[0] ? `<img src="${p.images[0]}" alt="" style="width:100%;max-height:140px;object-fit:cover;border-radius:10px;margin-top:8px;">` : ''}
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
            <a class="btn" href="/product.supabase.html?slug=${encodeURIComponent(p.slug)}" target="_blank" style="text-decoration:none;"><button>View</button></a>
            <button onclick="prefill('${p.slug.replace(/'/g, "\'")}')">Edit</button>
            <button onclick="deleteProduct('${p.id}')">Delete</button>
          </div>
        </div>`).join('');
    }

    window.deleteProduct = async (id) => {
      if (!confirm('Delete this product?')) return;
      const { error } = await supabase.from('products').delete().eq('id', id);
      if (error) alert(error.message); else loadList();
    };

    window.prefill = async (slug) => {
      const { data, error } = await supabase.from('products').select('*').eq('slug', slug).limit(1).maybeSingle();
      if (error || !data) { alert('Failed to load'); return; }
      document.getElementById('name').value = data.name || '';
      document.getElementById('slug').value = data.slug || '';
      document.getElementById('price').value = data.price || 0;
      document.getElementById('short').value = data.short || '';
      document.getElementById('description').value = data.description || '';
      document.getElementById('tags').value = (data.tags || []).join(', ');
      document.getElementById('in_stock').value = data.in_stock ? 'true' : 'false';
      document.getElementById('specs').value = Object.entries(data.specs || {}).map(([k,v]) => k+': '+v).join('\n');
      document.getElementById('images').value = ''; // user can re-upload to replace
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
  </script>
</body>
</html>
